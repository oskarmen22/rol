<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROL DE DESPACHADORES - EN LÍNEA</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal { background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dropdown-menu { transform-origin: top right; transition: transform 0.1s ease-out, opacity 0.1s ease-out; }
        .droppable-hover { background-color: #f0f9ff; border-color: #3b82f6; border-style: dashed; }
        .card-selected { border: 2px solid #2563eb !important; background-color: #eff6ff !important; transform: scale(0.98); box-shadow: 0 0 10px rgba(37, 99, 235, 0.2); }

        @media print {
            body, html { height: auto !important; overflow: visible !important; background: white !important; }
            header, #tab-nav, main, .modal, #btnNewDispatcher, #status-indicator { display: none !important; }
            #printable-area { display: block !important; width: 100% !important; padding: 20px !important; }
            table.print-table { width: 100%; border-collapse: collapse; font-family: sans-serif; font-size: 11pt; }
            table.print-table th { background-color: #f0f0f0 !important; color: black !important; font-weight: bold; border: 1px solid #000; padding: 8px; text-transform: uppercase; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            table.print-table td { border: 1px solid #000; padding: 8px; vertical-align: middle; }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-700 font-sans h-screen flex flex-col overflow-hidden" onclick="closeAllMenus()">

    <!-- Encabezado -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shrink-0 z-20">
        <div class="flex items-center gap-3 text-slate-800">
            <div class="bg-blue-800 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-clipboard-list"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight uppercase leading-none">Rol de Despachadores</h1>
                <!-- Indicador de estado mejorado para depuración -->
                <div id="status-indicator" class="text-[10px] text-orange-500 font-bold flex items-center gap-1 mt-1 cursor-help" title="Estado de la conexión">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Inicializando...
                </div>
            </div>
        </div>
        
        <button id="btnNewDispatcher" onclick="openAddModal()" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm flex items-center gap-2">
            <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Nuevo Despachador</span>
        </button>
    </header>

    <!-- Navegación -->
    <div id="tab-nav" class="bg-white border-b border-slate-100 shrink-0">
        <div class="flex max-w-6xl mx-auto px-4">
            <button onclick="switchTab('despachadores')" id="tab-despachadores" class="mr-6 py-3 text-sm font-semibold border-b-2 border-slate-800 text-slate-800 transition-colors">Despachadores</button>
            <button onclick="switchTab('roles')" id="tab-roles" class="mr-6 py-3 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors">Tabla de Roles</button>
            <button onclick="switchTab('opciones')" id="tab-opciones" class="py-3 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors">Opciones</button>
        </div>
    </div>

    <!-- Contenido -->
    <main class="flex-1 overflow-y-auto relative bg-gray-50">
        <div class="max-w-6xl mx-auto h-full p-4 md:p-8">
            <!-- VISTA: Despachadores -->
            <div id="view-despachadores" class="fade-in flex flex-col h-full">
                <div class="flex justify-between items-end mb-4 px-2">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Listado Activo</p>
                    <span id="counter" class="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600 font-bold">0</span>
                </div>
                <div id="listaDespachadores" class="space-y-3 pb-20"></div>
            </div>

            <!-- VISTA: Roles -->
            <div id="view-roles" class="hidden fade-in h-full flex flex-col">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col">
                    <div class="grid grid-cols-12 bg-slate-100 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase py-3 px-4">
                        <div class="col-span-4 md:col-span-3">Fecha</div>
                        <div class="col-span-4">Despachador 1</div>
                        <div class="col-span-4">Despachador 2</div>
                        <div class="col-span-1 text-right no-print">
                            <button onclick="clearSelection()" id="btnClearSelection" class="hidden text-xs text-blue-600 hover:underline">Limpiar Selección</button>
                        </div> 
                    </div>
                    <div id="roleTableBody" class="overflow-y-auto flex-1 divide-y divide-slate-100">
                        <div class="p-8 text-center text-slate-400">
                            <i class="fa-solid fa-cloud-arrow-down text-3xl mb-2 animate-bounce"></i>
                            <p id="loading-text">Sincronizando datos...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA: Opciones -->
            <!-- CORRECCIÓN AQUÍ: Se cambió id="view-options" a id="view-opciones" para coincidir con el JS -->
            <div id="view-opciones" class="hidden fade-in h-full">
                <div class="max-w-lg mx-auto space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-calendar text-blue-600"></i> Configuración</h3>
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Inicio del Rol (Lunes)</label>
                            <div class="flex gap-2">
                                <input type="date" id="roleStartDate" onchange="saveStartDate(this.value)" disabled class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700 disabled:opacity-60 disabled:cursor-not-allowed">
                                <button onclick="openPasswordModal()" id="btnUnlockDate" class="px-4 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200 border border-slate-200"><i class="fa-solid fa-lock"></i></button>
                            </div>
                            <p class="text-xs text-slate-400 mt-2"><i class="fa-solid fa-shield-halved mr-1"></i> Protegido por contraseña</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-file-pdf text-red-600"></i> Exportar</h3>
                        <p class="text-sm text-slate-500 mb-4">Elige una opción para exportar.</p>
                        <button onclick="askToPrint()" class="w-full py-3 bg-slate-800 text-white rounded-lg text-sm font-medium hover:bg-slate-700 flex items-center justify-center gap-2 shadow-md"><i class="fa-solid fa-print"></i> Opciones de Exportación</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ÁREA IMPRESIÓN -->
    <div id="printable-area" class="hidden"></div>

    <!-- MODALES (Contraseña, Alertas, etc) -->
    <div id="modalPassword" class="fixed inset-0 modal hidden flex items-center justify-center z-[80] p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-6 text-center"><div class="mb-4 text-slate-800 font-bold text-lg"><i class="fa-solid fa-lock mr-2 text-blue-600"></i>Seguridad</div><p class="text-sm text-slate-500 mb-4">Ingresa la contraseña.</p><input type="password" id="inputPassword" class="w-full px-3 py-2 border border-slate-200 rounded-lg mb-4 text-center text-lg" placeholder="****"><div class="flex gap-2"><button onclick="closePasswordModal()" class="flex-1 py-2 border rounded-lg text-slate-600 text-sm">Cancelar</button><button onclick="checkPassword()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg text-sm">Aceptar</button></div></div></div>
    <div id="modalAlert" class="fixed inset-0 modal hidden flex items-center justify-center z-[90] p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-6 text-center"><div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i class="fa-solid fa-triangle-exclamation"></i></div><p id="alertMessage" class="text-slate-700 font-medium mb-4 text-sm"></p><button onclick="closeAlertModal()" class="w-full py-2 bg-slate-800 text-white rounded-lg text-sm">Entendido</button></div></div>
    <div id="modalConfirmAction" class="fixed inset-0 modal hidden flex items-center justify-center z-[90] p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 text-center"><div class="w-12 h-12 bg-yellow-50 text-yellow-500 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i class="fa-solid fa-question"></i></div><h3 id="confirmTitle" class="font-bold text-lg text-slate-800 mb-2">¿Estás seguro?</h3><p id="confirmMessage" class="text-sm text-slate-500 mb-6"></p><div class="flex gap-2"><button onclick="closeConfirmModal()" class="flex-1 py-2 border rounded-lg text-slate-600 text-sm">Cancelar</button><button id="btnConfirmAction" onclick="executeConfirm()" class="flex-1 py-2 bg-slate-800 text-white rounded-lg text-sm">Confirmar</button></div></div></div>
    <div id="modalPrintAsk" class="fixed inset-0 modal hidden flex items-center justify-center z-[70] p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 text-center"><div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-print"></i></div><h3 class="font-bold text-lg text-slate-800 mb-2">Exportar</h3><p class="text-sm text-slate-500 mb-6">Selecciona formato.</p><div class="space-y-3"><button onclick="confirmPrint('pdf')" class="w-full py-3 bg-red-600 text-white rounded-lg font-medium flex items-center justify-center gap-2"><i class="fa-solid fa-file-pdf"></i> Generar PDF</button><button onclick="confirmPrint('print')" class="w-full py-3 bg-slate-800 text-white rounded-lg font-medium flex items-center justify-center gap-2"><i class="fa-solid fa-print"></i> Imprimir</button><button onclick="closePrintAskModal()" class="w-full py-2 border text-slate-600 rounded-lg text-sm mt-2">Cancelar</button></div></div></div>
    
    <!-- Modal Add/Edit/Info/Swap/Select (Standard) -->
    <div id="modalAdd" class="fixed inset-0 modal hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6"><h3 class="font-bold text-lg text-slate-800 mb-4">Nuevo Despachador</h3><div class="space-y-4"><input type="text" id="addNombre" placeholder="Nombre" class="w-full px-3 py-2 bg-slate-50 border rounded-lg"><input type="text" id="addApellido" placeholder="Apellido" class="w-full px-3 py-2 bg-slate-50 border rounded-lg"><input type="text" id="addArea" placeholder="Zona (Ej: Norte)" class="w-full px-3 py-2 bg-slate-50 border rounded-lg"></div><div class="mt-6 flex gap-3"><button onclick="closeAddModal()" class="flex-1 py-2 border rounded-lg">Cancelar</button><button onclick="saveNewDispatcher()" class="flex-1 py-2 bg-slate-900 text-white rounded-lg">Guardar</button></div></div></div>
    <div id="modalEdit" class="fixed inset-0 modal hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6"><h3 class="font-bold text-lg text-slate-800 mb-4">Editar Datos</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre</label><input type="text" id="editNombre" class="w-full px-3 py-2 bg-slate-50 border rounded-lg"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Apellido</label><input type="text" id="editApellido" class="w-full px-3 py-2 bg-slate-50 border rounded-lg"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Zona</label><input type="text" id="editArea" class="w-full px-3 py-2 bg-slate-50 border rounded-lg"></div><div id="editReasonContainer" class="hidden"><label class="block text-xs font-bold text-red-500 uppercase mb-1">Razón</label><textarea id="editReason" rows="2" class="w-full px-3 py-2 bg-red-50 border border-red-200 rounded-lg text-slate-700"></textarea></div></div><div class="mt-6 flex gap-3"><button onclick="closeEditModal()" class="flex-1 py-2 border rounded-lg">Cancelar</button><button onclick="saveEditDispatcher()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg">Guardar</button></div></div></div>
    <div id="modalDisable" class="fixed inset-0 modal hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden"><div class="bg-red-50 p-6 pb-4"><h3 class="font-bold text-xl text-slate-800"><i class="fa-solid fa-user-lock mr-2 text-red-500"></i>Inhabilitar</h3><p class="text-sm text-slate-500 mt-1"><span id="modalDisableName"></span></p></div><div class="p-6 pt-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hasta</label><input type="date" id="modalDisableDate" class="w-full px-3 py-2 border rounded-lg mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Motivo</label><textarea id="modalDisableReason" rows="2" class="w-full px-3 py-2 border rounded-lg resize-none"></textarea><div class="flex gap-3 justify-end mt-4"><button onclick="closeDisableModal()" class="px-4 py-2 border rounded-lg text-sm">Cancelar</button><button onclick="confirmDisable()" class="px-6 py-2 bg-red-500 text-white rounded-lg text-sm">Confirmar</button></div></div></div></div>
    <div id="modalInfo" class="fixed inset-0 modal hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative p-8 text-center"><button onclick="closeInfoModal()" class="absolute top-4 right-4 text-slate-300"><i class="fa-solid fa-times"></i></button><div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-ban"></i></div><h2 class="text-lg font-bold text-slate-800" id="infoName"></h2><div class="mt-6 bg-slate-50 p-4 rounded-xl border border-slate-100 text-left"><p class="text-xs text-slate-400 font-bold uppercase">Disponible en</p><p id="infoDays" class="text-lg font-bold text-blue-600"></p><p class="text-xs text-slate-400 font-bold uppercase mt-3">Motivo</p><p id="infoReason" class="text-sm text-slate-600 italic"></p></div><button onclick="confirmReenable()" class="w-full mt-4 py-3 rounded-xl border border-blue-100 text-blue-600 hover:bg-blue-50 text-sm font-medium">Re-habilitar ahora</button></div></div>
    <div id="modalSelectDispatcher" class="fixed inset-0 modal hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[80vh]"><div class="p-4 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-800">Asignar a <span id="selectTargetDate" class="text-blue-600"></span></h3><button onclick="closeSelectModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button></div><div id="selectList" class="overflow-y-auto p-2 space-y-1 flex-1"></div><div class="p-3 bg-slate-50 border-t border-slate-100 text-xs text-slate-500">Solo mostrados según reglas.</div></div></div>
    <div id="modalSwap" class="fixed inset-0 modal hidden flex items-center justify-center z-[60] p-4"><div class="bg-white rounded-xl shadow-xl p-6 max-w-sm text-center"><div class="mb-4 text-orange-500 text-3xl"><i class="fa-solid fa-right-left"></i></div><h3 class="font-bold text-lg text-slate-800 mb-2">Lugar Ocupado</h3><p class="text-sm text-slate-600 mb-6">El destino ya tiene un despachador asignado.</p><div class="flex flex-col gap-2"><button onclick="resolveSwap('swap')" id="btnSwap" class="py-2 px-4 bg-blue-600 text-white rounded-lg">Intercambiar</button><button onclick="resolveSwap('overwrite')" class="py-2 px-4 bg-red-500 text-white rounded-lg">Sobrescribir</button><button onclick="closeSwapModal()" class="py-2 px-4 border rounded-lg">Cancelar</button></div></div></div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // ==========================================
        //  CONFIGURACIÓN PARA GITHUB / LOCAL
        // ==========================================
        
        const manualConfig = {
          apiKey: "AIzaSyArRVSxwFF5-9D48VS-AZsb6_e2oIBUESk",
          authDomain: "rol-de-despachadores.firebaseapp.com",
          projectId: "rol-de-despachadores",
          storageBucket: "rol-de-despachadores.firebasestorage.app",
          messagingSenderId: "130708013498",
          appId: "1:130708013498:web:eb44b35cbbd59dc1d5dd83",
          measurementId: "G-77R1SFYX26"
        }; 

        // ==========================================
        
        let app, db, auth;
        let COLLECTION_PREFIX = '';
        let appId = 'default';

        // Detectar Entorno
        if (typeof __firebase_config !== 'undefined') {
            app = initializeApp(JSON.parse(__firebase_config));
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            COLLECTION_PREFIX = `artifacts/${appId}/public/data/`;
        } else if (manualConfig) {
            app = initializeApp(manualConfig);
            COLLECTION_PREFIX = ''; 
        }

        const indicator = document.getElementById('status-indicator');

        // Manejo de errores global
        window.onerror = function(msg, url, line) {
            indicator.innerHTML = `<i class="fa-solid fa-bug text-red-500"></i> Error de Script`;
            console.error("Global Error:", msg);
            return false;
        };

        if (app) {
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Logica de Auth con manejo de errores
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth Error:", error);
                    let msg = "Error de Conexión";
                    if(error.code === 'auth/operation-not-allowed') msg = "Auth Anónimo Apagado (Consola)";
                    else if(error.code === 'auth/invalid-api-key') msg = "API Key Inválida";
                    else if(error.code === 'auth/network-request-failed') msg = "Sin Internet";
                    
                    indicator.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> ${msg}`;
                    document.getElementById('loading-text').innerText = `Error: ${msg}. Revisa la consola (F12).`;
                }
            };
            initAuth();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    indicator.innerHTML = '<i class="fa-solid fa-wifi text-green-500"></i> En Línea';
                    indicator.classList.replace('text-orange-500', 'text-green-600');
                    startListeners();
                } else {
                    // Si no hay user y no hubo error arriba, probablemente inicializando
                }
            });
        } else {
            indicator.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Sin Config';
        }

        // --- ESTADO LOCAL ---
        window.dispatchers = [];
        window.roles = {}; 
        window.currentRoleDates = [];
        window.roleStartDateString = '2026-01-05'; 

        // --- LISTENERS ---
        function startListeners() {
            // Despachadores
            const dispCol = collection(db, COLLECTION_PREFIX + 'dispatchers');
            onSnapshot(dispCol, (snapshot) => {
                window.dispatchers = [];
                snapshot.forEach(doc => {
                    window.dispatchers.push({ id: doc.id, ...doc.data() });
                });
                renderDispatchers();
                if(!document.getElementById('view-roles').classList.contains('hidden')) renderRoleTable();
            }, (error) => {
                console.error("Firestore Error (Dispatchers):", error);
                if(error.code === 'permission-denied') {
                    indicator.innerHTML = '<i class="fa-solid fa-lock text-red-500"></i> Permiso Denegado';
                    alert("Error: Permiso denegado. Revisa las reglas de Firestore.");
                }
            });

            // Roles
            const rolesCol = collection(db, COLLECTION_PREFIX + 'roles');
            onSnapshot(rolesCol, (snapshot) => {
                window.roles = {};
                snapshot.forEach(doc => {
                    window.roles[doc.id] = doc.data();
                });
                renderRoleTable();
            });

            // Config
            const configRef = doc(db, COLLECTION_PREFIX + 'config', 'main');
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.startDate) {
                        window.roleStartDateString = data.startDate;
                        document.getElementById('roleStartDate').value = data.startDate;
                        recalcDates();
                    }
                } else {
                    setDoc(configRef, { startDate: '2026-01-05' }).catch(e => console.log("Init config write pending auth"));
                }
            });
        }

        // --- OPERACIONES DB (Async) ---
        
        window.saveNewDispatcher = async function() {
            const n = document.getElementById('addNombre').value.trim();
            const l = document.getElementById('addApellido').value.trim();
            const a = document.getElementById('addArea').value.trim();
            if(!n || !l || !a) { showAlert("Faltan datos"); return; }
            
            const newDocRef = doc(collection(db, COLLECTION_PREFIX + 'dispatchers'));
            await setDoc(newDocRef, {
                name: n, lastname: l, area: a, active: true, disabledUntil: null, reason: ''
            });
            closeAddModal();
        }

        window.deleteDispatcher = function(id) {
            showConfirm("¿Eliminar?", "Se borrará permanentemente.", async () => {
                await deleteDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', id));
            });
        }

        window.saveEditDispatcher = async function() {
            if (!editingId) return;
            const n = document.getElementById('editNombre').value.trim();
            const l = document.getElementById('editApellido').value.trim();
            const a = document.getElementById('editArea').value.trim();
            
            const updateData = { name: n, lastname: l, area: a };
            const d = window.dispatchers.find(x => x.id === editingId);
            if (!d.active) updateData.reason = document.getElementById('editReason').value;

            await updateDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', editingId), updateData);
            closeEditModal();
        }

        window.confirmDisable = async function() {
            const date = document.getElementById('modalDisableDate').value;
            const r = document.getElementById('modalDisableReason').value;
            if(!date || !r) return showAlert("Faltan datos");
            
            await updateDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', editingId), {
                active: false, disabledUntil: date, reason: r
            });
            closeDisableModal();
        }

        window.confirmReenable = async function() {
            await updateDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', viewingId), {
                active: true, disabledUntil: null, reason: ''
            });
            closeInfoModal();
        }

        window.assignDispatcher = async function(id) {
            const roleRef = doc(db, COLLECTION_PREFIX + 'roles', selectedDate);
            const updateData = {};
            updateData[selectedSlot] = id;
            await setDoc(roleRef, updateData, { merge: true });
            closeSelectModal();
        }

        window.clearRoleSlot = async function(d, s) {
            const roleRef = doc(db, COLLECTION_PREFIX + 'roles', d);
            const updateData = {};
            updateData[s] = null; 
            await updateDoc(roleRef, updateData).catch(async (e) => {});
            window.selectedSlots = window.selectedSlots.filter(sl => !(sl.date === d && sl.slot === s));
            renderRoleTable();
        }

        window.performMove = async function(fd, fs, td, ts) {
            await updateDoc(doc(db, COLLECTION_PREFIX + 'roles', fd), { [fs]: null });
            await setDoc(doc(db, COLLECTION_PREFIX + 'roles', td), { [ts]: draggedData.id }, { merge: true });
            draggedData = null;
        }

        window.executeGroupMove = async function(moves) {
            const promises = [];
            for (const m of moves) {
                const ref = doc(db, COLLECTION_PREFIX + 'roles', m.oldDate);
                promises.push(updateDoc(ref, { [m.oldSlot]: null }));
            }
            await Promise.all(promises);

            const writePromises = [];
            for (const m of moves) {
                const ref = doc(db, COLLECTION_PREFIX + 'roles', m.newDate);
                writePromises.push(setDoc(ref, { [m.newSlot]: m.id }, { merge: true }));
            }
            await Promise.all(writePromises);
            window.selectedSlots = [];
            renderRoleTable();
        }

        window.saveStartDate = async function(val) {
            await setDoc(doc(db, COLLECTION_PREFIX + 'config', 'main'), { startDate: val });
        }

        // ==========================================
        //  UI & LOGIC (LOCAL)
        // ==========================================
        
        let editingId = null; 
        let viewingId = null;
        let selectedDate = null; 
        let selectedSlot = null; 
        window.selectedSlots = []; 
        let draggedData = null; 
        let swapTargetData = null;
        let confirmCallback = null; 

        // -- Helpers --
        window.showAlert = (msg) => { document.getElementById('alertMessage').innerText = msg; document.getElementById('modalAlert').classList.remove('hidden'); }
        window.closeAlertModal = () => document.getElementById('modalAlert').classList.add('hidden');
        window.showConfirm = (title, msg, callback) => { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMessage').innerText = msg; confirmCallback = callback; document.getElementById('modalConfirmAction').classList.remove('hidden'); }
        window.executeConfirm = () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); }
        window.closeConfirmModal = () => { document.getElementById('modalConfirmAction').classList.add('hidden'); confirmCallback = null; }
        
        window.openPasswordModal = () => { if(!document.getElementById('roleStartDate').disabled) return; document.getElementById('inputPassword').value=''; document.getElementById('modalPassword').classList.remove('hidden'); setTimeout(()=>document.getElementById('inputPassword').focus(),100); }
        window.closePasswordModal = () => document.getElementById('modalPassword').classList.add('hidden');
        window.checkPassword = () => { if(document.getElementById('inputPassword').value==="1235"){ document.getElementById('roleStartDate').disabled=false; document.getElementById('btnUnlockDate').innerHTML='<i class="fa-solid fa-lock-open text-green-500"></i>'; closePasswordModal(); showAlert("Fecha desbloqueada."); } else { showAlert("Contraseña incorrecta."); } }

        window.switchTab = (tab) => {
            const views = ['despachadores', 'roles', 'opciones'];
            views.forEach(v => {
                const viewEl = document.getElementById('view-'+v);
                const tabEl = document.getElementById('tab-'+v);
                if (viewEl) viewEl.classList.add('hidden');
                if (tabEl) {
                    tabEl.classList.replace('border-slate-800','border-transparent');
                    tabEl.classList.replace('text-slate-800','text-slate-400');
                }
            });
            const selectedView = document.getElementById('view-'+tab);
            const selectedTab = document.getElementById('tab-'+tab);
            
            if (selectedView) selectedView.classList.remove('hidden');
            if (selectedTab) {
                selectedTab.classList.replace('border-transparent','border-slate-800');
                selectedTab.classList.replace('text-slate-400','text-slate-800');
            }
            
            const btnNew = document.getElementById('btnNewDispatcher');
            if(tab === 'despachadores') { 
                if (btnNew) {
                    btnNew.classList.remove('hidden'); 
                    btnNew.classList.add('flex'); 
                }
            } else { 
                if (btnNew) {
                    btnNew.classList.add('hidden'); 
                    btnNew.classList.remove('flex'); 
                }
            }
            
            if(tab === 'roles') {
                recalcDates();
                renderRoleTable();
            }
        }

        window.askToPrint = () => document.getElementById('modalPrintAsk').classList.remove('hidden');
        window.closePrintAskModal = () => document.getElementById('modalPrintAsk').classList.add('hidden');
        window.confirmPrint = (m) => { closePrintAskModal(); setTimeout(()=>window.print(),300); }

        window.openEditModal = (id) => {
            editingId = id;
            const d = window.dispatchers.find(x => x.id === id);
            document.getElementById('editNombre').value = d.name;
            document.getElementById('editApellido').value = d.lastname;
            document.getElementById('editArea').value = d.area;
            const rc = document.getElementById('editReasonContainer');
            if(!d.active){ rc.classList.remove('hidden'); document.getElementById('editReason').value = d.reason; } else { rc.classList.add('hidden'); }
            closeAllMenus();
            document.getElementById('modalEdit').classList.remove('hidden');
        }
        window.closeEditModal = () => { document.getElementById('modalEdit').classList.add('hidden'); editingId = null; }

        window.renderDispatchers = () => {
            const c = document.getElementById('listaDespachadores');
            document.getElementById('counter').innerText = window.dispatchers.length;
            c.innerHTML = '';
            if(window.dispatchers.length===0) { c.innerHTML='<div class="text-center py-10 opacity-50">Sin datos</div>'; return; }
            
            window.dispatchers.forEach(d => {
                const el = document.createElement('div');
                const base = "relative bg-white p-4 rounded-xl border transition-all flex items-center justify-between group z-0";
                const st = d.active ? "border-slate-100 shadow-sm hover:shadow-md hover:border-blue-100" : "border-red-100 bg-red-50/30";
                const icon = d.active ? `<div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center"><i class="fa-solid fa-user"></i></div>` : `<div class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center"><i class="fa-solid fa-user-slash"></i></div>`;
                const btn = d.active ? `<button onclick="handleStatus(event, '${d.id}')" class="px-3 py-1 bg-green-50 text-green-600 text-xs font-bold rounded-md hover:bg-green-100 border border-green-100">HABILITADO</button>` : `<button onclick="handleStatus(event, '${d.id}')" class="px-3 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-md hover:bg-red-200 border border-red-200">INHABILITADO</button>`;
                
                if(!d.active) { el.onclick = (e) => { if(!e.target.closest('button')) showInfoModal(d.id); }; el.style.cursor='pointer'; }
                el.className = `${base} ${st}`;
                el.innerHTML = `
                    <div class="flex items-center gap-4">${icon}<div><h4 class="${d.active?'text-slate-800':'text-red-800'} font-bold text-base">${d.name} ${d.lastname} <span class="text-xs font-normal text-slate-400 ml-1">(${d.area})</span></h4></div></div>
                    <div class="flex items-center gap-4">${btn}
                        <div class="relative"><button onclick="toggleMenu(event, 'menu-${d.id}')" class="w-8 h-8 rounded-full hover:bg-slate-100 text-slate-400 flex items-center justify-center"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div id="menu-${d.id}" class="dropdown-menu hidden absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-xl border border-slate-100 z-10 overflow-hidden">
                                <button onclick="openEditModal('${d.id}')" class="w-full text-left px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2 border-b"><i class="fa-solid fa-pen-to-square text-xs text-blue-500"></i> Editar Datos</button>
                                <button onclick="deleteDispatcher('${d.id}')" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"><i class="fa-solid fa-trash-can text-xs"></i> Eliminar</button>
                            </div>
                        </div>
                    </div>`;
                c.appendChild(el);
            });
        }

        window.recalcDates = () => {
            const startDate = new Date(window.roleStartDateString + 'T12:00:00');
            window.currentRoleDates = [];
            let processDate = new Date(startDate);
            let daysAdded = 0;
            while(daysAdded < 12) {
                if(processDate.getDay() !== 0) {
                    window.currentRoleDates.push(processDate.toISOString().split('T')[0]);
                    daysAdded++;
                }
                processDate.setDate(processDate.getDate() + 1);
            }
        }

        window.renderRoleTable = () => {
            if(window.currentRoleDates.length === 0) recalcDates();
            const c = document.getElementById('roleTableBody');
            const pc = document.getElementById('printable-area');
            c.innerHTML = '';
            
            // Print Logic
            let printHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="font-size: 24px; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid black; display: inline-block; padding-bottom: 5px;">Tabla de Rol</h1>
                    <p style="margin-top: 5px; font-size: 14px; color: #666;">Inicio: ${new Date(window.currentRoleDates[0]).toLocaleDateString()}</p>
                </div>
                <table class="print-table"><thead><tr><th style="width: 20%">FECHA</th><th style="width: 40%">DESPACHADOR 1</th><th style="width: 40%">DESPACHADOR 2</th></tr></thead><tbody>`;

            // Display Logic
            document.getElementById('btnClearSelection').classList.toggle('hidden', window.selectedSlots.length === 0);

            window.currentRoleDates.forEach(dateStr => {
                const dateObj = new Date(dateStr + 'T12:00:00');
                const dateFmt = new Intl.DateTimeFormat('es-ES', { weekday: 'long', day: 'numeric', month: 'short', year: '2-digit' }).format(dateObj).toUpperCase().replace('.', '');
                
                const roleData = window.roles[dateStr] || {};
                const d1Id = roleData[0];
                const d2Id = roleData[1];

                const row = document.createElement('div');
                row.className = "grid grid-cols-12 border-b border-slate-100 hover:bg-slate-50 transition-colors items-stretch min-h-[60px]";
                row.innerHTML = `<div class="col-span-4 md:col-span-3 p-3 flex items-center border-r border-slate-100 bg-white"><span class="text-xs font-bold text-slate-700 leading-tight">${dateFmt}</span></div>
                    <div class="col-span-4 p-2 border-r border-slate-100 relative group droppable-area" ondragover="allowDrop(event)" ondrop="drop(event, '${dateStr}', 0)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">${renderSlotContent(dateStr, 0, d1Id)}</div>
                    <div class="col-span-4 p-2 relative group droppable-area" ondragover="allowDrop(event)" ondrop="drop(event, '${dateStr}', 1)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">${renderSlotContent(dateStr, 1, d2Id)}</div>
                    <div class="col-span-1 no-print"></div>`;
                c.appendChild(row);

                // Print row
                const d1 = d1Id ? window.dispatchers.find(d => d.id === d1Id) : null;
                const d2 = d2Id ? window.dispatchers.find(d => d.id === d2Id) : null;
                const t1 = d1 ? `<b>${d1.name} ${d1.lastname}</b> (${d1.area})` : 'Vacante';
                const t2 = d2 ? `<b>${d2.name} ${d2.lastname}</b> (${d2.area})` : 'Vacante';
                printHTML += `<tr><td style="font-weight: bold;">${dateFmt}</td><td>${t1}</td><td>${t2}</td></tr>`;
            });
            printHTML += `</tbody></table>`;
            pc.innerHTML = printHTML;
        }

        window.renderSlotContent = (date, slot, dispatcherId) => {
            if (!dispatcherId) return `<button onclick="openSelectModal('${date}', ${slot})" class="w-full h-full border border-dashed border-slate-300 rounded-lg text-slate-300 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all flex items-center justify-center text-xs font-medium"><i class="fa-solid fa-plus mr-1"></i> Seleccionar</button>`;
            const disp = window.dispatchers.find(d => d.id === dispatcherId);
            if (!disp) return '<span class="text-xs text-red-400">Error ID</span>'; 

            const isSel = window.selectedSlots.some(s => s.date === date && s.slot === slot);
            const cl = isSel ? 'card-selected' : 'border-slate-200 hover:border-blue-300';

            return `<div class="w-full h-full bg-white border ${cl} shadow-sm rounded-lg p-2 flex items-center justify-between cursor-grab active:cursor-grabbing transition-all" draggable="true" ondragstart="drag(event, '${date}', ${slot}, '${dispatcherId}')">
                <div class="overflow-hidden"><p class="text-xs font-bold text-slate-800 truncate">${disp.name} ${disp.lastname}</p><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">(${disp.area})</p></div>
                <div class="relative no-print ml-1">
                    <button onclick="toggleMenu(event, 'role-menu-${date}-${slot}')" class="text-slate-400 hover:text-slate-600 p-1 rounded hover:bg-slate-100"><i class="fa-solid fa-ellipsis-vertical text-xs"></i></button>
                    <div id="role-menu-${date}-${slot}" class="role-cell-menu dropdown-menu hidden absolute right-0 top-full mt-1 w-40 bg-white rounded shadow-xl border border-slate-200 z-50 overflow-hidden">
                        <button onclick="openSelectModal('${date}', ${slot})" class="w-full text-left px-3 py-2 text-xs text-blue-600 hover:bg-blue-50 flex items-center gap-2 border-b"><i class="fa-solid fa-rotate"></i> Reemplazar</button>
                        <button onclick="toggleSelection('${date}', ${slot})" class="w-full text-left px-3 py-2 text-xs text-slate-600 hover:bg-slate-50 flex items-center gap-2 border-b"><i class="fa-solid fa-check-square"></i> ${isSel?'Deseleccionar':'Seleccionar'}</button>
                        <button onclick="clearRoleSlot('${date}', ${slot})" class="w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-red-50 flex items-center gap-2"><i class="fa-solid fa-eraser"></i> Borrar</button>
                    </div>
                </div></div>`;
        }

        // --- REGLAS ---
        function getWeekIndex(dateStr) {
            const idx = window.currentRoleDates.indexOf(dateStr);
            if (idx === -1) return -1;
            return idx < 6 ? 0 : 1;
        }

        function checkRules(targetDate, targetSlot, dispatcherId, excludeDate = null, excludeSlot = null) {
            const partnerSlot = targetSlot === 0 ? 1 : 0;
            const roleData = window.roles[targetDate] || {};
            const partnerId = roleData[partnerSlot];
            
            // 1. Zona
            if (partnerId && partnerId !== dispatcherId) {
                const partner = window.dispatchers.find(d => d.id === partnerId);
                const mover = window.dispatchers.find(d => d.id === dispatcherId);
                if (partner && mover && partner.area === mover.area) {
                    return { valid: false, msg: `Zona repetida (${mover.area}) en ${new Date(targetDate).toLocaleDateString()}.` };
                }
            }

            // 2. Frecuencia
            const targetWeek = getWeekIndex(targetDate);
            let countWeek = 0;
            let countTotal = 0;

            for (const d of window.currentRoleDates) {
                const r = window.roles[d];
                if (!r) continue;
                for (let s = 0; s <= 1; s++) {
                    const id = r[s];
                    if (id === dispatcherId) {
                        if (d === excludeDate && s === excludeSlot) continue;
                        countTotal++;
                        if (getWeekIndex(d) === targetWeek) countWeek++;
                    }
                }
            }

            if (countWeek >= 1) return { valid: false, msg: `Ya tiene turno esa semana (Máx 1).` };
            if (countTotal >= 2) return { valid: false, msg: `Ya tiene 2 turnos (Máx 2).` };

            return { valid: true };
        }

        // --- INTERACCIONES ---
        window.openSelectModal = (d, s) => {
            selectedDate=d; selectedSlot=s;
            const c = document.getElementById('selectList');
            document.getElementById('selectTargetDate').innerText = new Date(d+'T12:00:00').toLocaleDateString();
            c.innerHTML = '';
            
            const cands = window.dispatchers.filter(dp => {
                if(!dp.active) return false;
                const check = checkRules(d, s, dp.id);
                return check.valid;
            });

            if(cands.length === 0) c.innerHTML = '<div class="text-center p-4 text-slate-400 text-sm">No disponible por reglas.</div>';
            else cands.forEach(dp => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-3 hover:bg-blue-50 rounded-lg flex justify-between border border-transparent hover:border-blue-100";
                b.onclick = () => assignDispatcher(dp.id);
                b.innerHTML = `<div><span class="font-bold text-sm">${dp.name} ${dp.lastname}</span><span class="text-xs text-slate-400 ml-1">(${dp.area})</span></div>`;
                c.appendChild(b);
            });
            document.getElementById('modalSelectDispatcher').classList.remove('hidden');
        }

        window.toggleSelection = (d, s) => { closeAllMenus(); const idx = window.selectedSlots.findIndex(i => i.date === d && i.slot === s); if(idx === -1) window.selectedSlots.push({date:d, slot:s}); else window.selectedSlots.splice(idx, 1); renderRoleTable(); }
        window.clearSelection = () => { window.selectedSlots = []; renderRoleTable(); }
        window.closeSelectModal = () => document.getElementById('modalSelectDispatcher').classList.add('hidden');

        window.drag = (e,d,s,id) => { 
            const isGroup = window.selectedSlots.some(sl => sl.date === d && sl.slot === s);
            draggedData = { originDate: d, originSlot: s, id: id, isGroup: isGroup, group: isGroup ? [...window.selectedSlots] : [] };
            e.dataTransfer.setData("text", JSON.stringify(draggedData));
        }
        window.allowDrop = (e) => e.preventDefault();
        window.dragEnter = (e) => { e.preventDefault(); e.currentTarget.classList.add('droppable-hover'); }
        window.dragLeave = (e) => e.currentTarget.classList.remove('droppable-hover');
        
        window.drop = (e, td, ts) => {
            e.preventDefault(); e.currentTarget.classList.remove('droppable-hover');
            if(!draggedData) return;
            if(draggedData.isGroup && draggedData.group.length > 0) handleGroupDrop(td, ts);
            else { if(draggedData.originDate===td && draggedData.originSlot===ts) return; handleSingleDrop(td, ts); }
        }

        function handleSingleDrop(td, ts) {
            const check = checkRules(td, ts, draggedData.id, draggedData.originDate, draggedData.originSlot);
            if(!check.valid) return showAlert(check.msg);
            
            if(window.roles[td] && window.roles[td][ts]) {
                swapTargetData = { date: td, slot: ts, isGroup: false };
                document.getElementById('modalSwap').classList.remove('hidden');
            } else {
                performMove(draggedData.originDate, draggedData.originSlot, td, ts);
            }
        }

        function handleGroupDrop(td, ts) {
            const originIndex = window.currentRoleDates.indexOf(draggedData.originDate);
            const targetIndex = window.currentRoleDates.indexOf(td);
            const dayDiff = targetIndex - originIndex;
            
            let proposedMoves = [];
            for (let item of draggedData.group) {
                const itemOriginIdx = window.currentRoleDates.indexOf(item.date);
                const newIdx = itemOriginIdx + dayDiff;
                if(newIdx < 0 || newIdx >= window.currentRoleDates.length) return showAlert("Fuera de rango.");
                const newDate = window.currentRoleDates[newIdx];
                let newSlot = item.slot; 
                if(item.slot === draggedData.originSlot) newSlot = ts; 
                const dispatcherId = window.roles[item.date] ? window.roles[item.date][item.slot] : null;
                if(!dispatcherId) continue; 
                proposedMoves.push({ id: dispatcherId, oldDate: item.date, oldSlot: item.slot, newDate, newSlot });
            }

            let overwriteNeeded = false;
            for(let move of proposedMoves) {
                const check = checkRules(move.newDate, move.newSlot, move.id, move.oldDate, move.oldSlot);
                if(!check.valid) return showAlert("Conflicto en grupo: " + check.msg);
                
                const occupantId = window.roles[move.newDate] ? window.roles[move.newDate][move.newSlot] : null;
                const occupantIsLeaving = proposedMoves.some(m => m.oldDate === move.newDate && m.oldSlot === move.newSlot);
                if(occupantId && !occupantIsLeaving) overwriteNeeded = true;
            }

            if(overwriteNeeded) {
                swapTargetData = { isGroup: true, moves: proposedMoves };
                document.getElementById('btnSwap').classList.add('hidden');
                document.getElementById('modalSwap').classList.remove('hidden');
            } else {
                executeGroupMove(proposedMoves);
            }
        }

        window.resolveSwap = async function(action) {
            const isGroup = swapTargetData.isGroup;
            if(isGroup) {
                if(action === 'overwrite') await executeGroupMove(swapTargetData.moves);
                document.getElementById('btnSwap').classList.remove('hidden');
            } else {
                const o = draggedData; const t = swapTargetData;
                if(action === 'overwrite') {
                    await updateDoc(doc(db, COLLECTION_PREFIX + 'roles', t.date), { [t.slot]: null }); // Optional clean
                    await updateDoc(doc(db, COLLECTION_PREFIX + 'roles', o.originDate), { [o.originSlot]: null });
                    await setDoc(doc(db, COLLECTION_PREFIX + 'roles', t.date), { [t.slot]: o.id }, { merge: true });
                } else if(action === 'swap') {
                    const tId = window.roles[t.date][t.slot];
                    const checkX = checkRules(t.date, t.slot, o.id, o.originDate, o.originSlot);
                    const checkZ = checkRules(o.originDate, o.originSlot, tId, t.date, t.slot);
                    if(!checkX.valid || !checkZ.valid) { closeSwapModal(); return showAlert("Swap inválido por reglas."); }
                    
                    const p1 = setDoc(doc(db, COLLECTION_PREFIX + 'roles', o.originDate), { [o.originSlot]: tId }, { merge: true });
                    const p2 = setDoc(doc(db, COLLECTION_PREFIX + 'roles', t.date), { [t.slot]: o.id }, { merge: true });
                    await Promise.all([p1, p2]);
                }
            }
            closeSwapModal();
        }
        window.closeSwapModal = () => document.getElementById('modalSwap').classList.add('hidden');

        // --- UI BOILERPLATE ---
        window.toggleMenu = (e,id) => { e.stopPropagation(); closeAllMenus(); document.getElementById(id).classList.remove('hidden'); }
        window.closeAllMenus = () => document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.add('hidden'));
        window.openAddModal = () => { document.getElementById('addNombre').value=''; document.getElementById('addApellido').value=''; document.getElementById('addArea').value=''; document.getElementById('modalAdd').classList.remove('hidden'); }
        window.closeAddModal = () => document.getElementById('modalAdd').classList.add('hidden');
        window.handleStatus = (e,id) => { e.stopPropagation(); closeAllMenus(); const d=window.dispatchers.find(x=>x.id===id); if(d.active) openDisableModal(id); else showInfoModal(id); }
        window.openDisableModal = (id) => { editingId=id; const d=window.dispatchers.find(x=>x.id===id); document.getElementById('modalDisableName').innerText=`${d.name} ${d.lastname}`; document.getElementById('modalDisableDate').value=''; document.getElementById('modalDisableReason').value=''; document.getElementById('modalDisable').classList.remove('hidden'); }
        window.closeDisableModal = () => { document.getElementById('modalDisable').classList.add('hidden'); editingId=null; }
        window.showInfoModal = (id) => { viewingId=id; const d=window.dispatchers.find(x=>x.id===id); document.getElementById('infoName').innerText=`${d.name} ${d.lastname}`; document.getElementById('infoReason').innerText=d.reason; document.getElementById('infoDays').innerText=new Date(d.disabledUntil+'T12:00:00').toLocaleDateString(); document.getElementById('modalInfo').classList.remove('hidden'); }
        window.closeInfoModal = () => { document.getElementById('modalInfo').classList.add('hidden'); viewingId=null; }

        // Si no hay app (modo github sin config), inicializar UI basica
        if(!app) { renderDispatchers(); renderRoleTable(); }

    </script>
</body>
</html>
