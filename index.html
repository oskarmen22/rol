<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROL DE DESPACHADORES - FORRAJES EL BARRIO</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2pdf.js para generar PDF real -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Fondo del modal oscuro para detectar clic fuera */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Estilos visuales del tema Forrajes El Barrio */
        .card-selected { border: 2px solid #eab308 !important; background-color: #fefce8 !important; } /* Amarillo selección */
        .droppable-hover { background-color: #fef2f2; border-color: #ef4444; border-style: dashed; } /* Rojo suave al arrastrar */

        /* Estilos para el PDF generado */
        #printable-content {
            background: white;
            padding: 20px;
            font-family: sans-serif;
            color: #000;
        }
        .pdf-header {
            text-align: center;
            border-bottom: 3px solid #dc2626; /* Rojo */
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .pdf-table th {
            background-color: #dc2626;
            color: white;
            padding: 8px;
            text-transform: uppercase;
            border: 1px solid #991b1b;
        }
        .pdf-table td {
            border: 1px solid #ccc;
            padding: 8px;
        }
        .pdf-vacante { color: #ccc; font-style: italic; }
    </style>
</head>
<body class="bg-gray-100 text-black font-sans h-screen flex flex-col overflow-hidden text-sm md:text-base">

    <!-- Encabezado Tema Rojo/Blanco -->
    <header class="bg-white border-b-4 border-red-600 px-4 py-3 flex justify-between items-center shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3 overflow-hidden">
            
            <!-- CONTENEDOR DEL LOGOTIPO -->
            <div class="w-10 h-10 flex-shrink-0">
                <!-- 1. Intenta cargar 'logo.svg' -->
                <img src="logo.svg" alt="Forrajes El Barrio" class="w-full h-full object-contain" 
                     onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                
                <!-- 2. Si falla (no has subido el logo), muestra este icono por defecto -->
                <div class="hidden w-full h-full bg-red-700 text-yellow-400 rounded-lg flex items-center justify-center shadow-sm border-2 border-red-800">
                    <i class="fa-solid fa-wheat-awn text-xl"></i>
                </div>
            </div>

            <div class="min-w-0 flex items-center gap-2">
                <h1 class="text-sm md:text-lg font-black tracking-tight uppercase leading-tight truncate text-gray-900">ROL DE DESPACHADORES</h1>
                
                <!-- Nuevo Indicador de Estado (Punto) -->
                <div id="status-dot" class="w-3 h-3 rounded-full bg-orange-500 shadow-sm transition-colors duration-500" title="Estado de conexión"></div>
            </div>
        </div>
        
        <button id="btnNewDispatcher" onclick="openAddModal()" class="bg-red-600 hover:bg-red-700 text-white p-2 md:px-4 md:py-2 rounded-lg transition-all shadow-md flex items-center gap-2 flex-shrink-0 border-b-2 border-red-800 active:translate-y-0.5">
            <i class="fa-solid fa-plus text-yellow-300"></i> <span class="hidden md:inline text-sm font-bold">Nuevo</span>
        </button>
    </header>

    <!-- Navegación -->
    <div id="tab-nav" class="bg-white border-b border-gray-300 shrink-0 shadow-sm">
        <div class="flex">
            <button onclick="switchTab('despachadores')" id="tab-despachadores" class="flex-1 py-3 text-xs md:text-sm font-bold border-b-4 border-red-600 text-red-700 transition-colors uppercase tracking-wide text-center bg-gray-50"><i class="fa-solid fa-users md:mr-1"></i> <span class="block md:inline">Personal</span></button>
            <button onclick="switchTab('roles')" id="tab-roles" class="flex-1 py-3 text-xs md:text-sm font-bold border-b-4 border-transparent text-gray-400 hover:text-gray-600 transition-colors uppercase tracking-wide text-center"><i class="fa-solid fa-table-list md:mr-1"></i> <span class="block md:inline">Rol</span></button>
            <button onclick="switchTab('opciones')" id="tab-opciones" class="flex-1 py-3 text-xs md:text-sm font-bold border-b-4 border-transparent text-gray-400 hover:text-gray-600 transition-colors uppercase tracking-wide text-center"><i class="fa-solid fa-gear md:mr-1"></i> <span class="block md:inline">Opciones</span></button>
        </div>
    </div>

    <!-- Contenido -->
    <main class="flex-1 overflow-y-auto relative bg-gray-100 scroll-smooth">
        <div class="max-w-5xl mx-auto h-full p-3 md:p-6 pb-24">

            <!-- VISTA: Despachadores -->
            <div id="view-despachadores" class="fade-in flex flex-col h-full">
                <!-- Header con Buscador -->
                <div class="flex flex-col gap-3 mb-4">
                    <div class="flex justify-between items-end px-1">
                        <p class="text-[10px] md:text-xs font-black text-gray-400 uppercase tracking-wider">DIRECTORIO ACTIVO</p>
                        <span id="counter" class="text-[10px] md:text-xs bg-red-100 border border-red-200 px-2 py-0.5 rounded-full text-red-800 font-bold shadow-sm">0</span>
                    </div>
                    
                    <!-- Buscador -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="searchDispatcher" oninput="renderDispatchers()" class="block w-full pl-10 pr-3 py-3 border-2 border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:border-red-500 focus:ring-0 sm:text-sm shadow-sm transition-all font-medium" placeholder="Buscar nombre o zona...">
                    </div>
                </div>

                <div id="listaDespachadores" class="space-y-3"></div>
            </div>

            <!-- VISTA: Roles -->
            <div id="view-roles" class="hidden fade-in h-full flex flex-col">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex-1 flex flex-col">
                    <div class="hidden md:grid grid-cols-12 bg-gray-800 border-b border-gray-200 text-xs font-bold text-white uppercase py-3 px-4">
                        <div class="col-span-3">Fecha</div><div class="col-span-4">Despachador 1</div><div class="col-span-4">Despachador 2</div><div class="col-span-1 text-right no-print"></div> 
                    </div>
                    <!-- Barra de selección en Amarillo -->
                    <div id="selection-bar" class="hidden bg-yellow-100 border-b border-yellow-300 p-2 flex justify-between items-center text-xs text-yellow-800 px-4 font-bold shadow-inner">
                        <span><i class="fa-solid fa-check-double mr-1"></i> Selección Múltiple Activa</span>
                        <button onclick="clearSelection()" class="underline hover:text-black">Cancelar</button>
                    </div>
                    <div id="roleTableBody" class="overflow-y-auto flex-1 md:divide-y md:divide-gray-100 bg-gray-50 md:bg-white">
                        <div class="p-8 text-center text-gray-400 mt-10"><i class="fa-solid fa-cloud-arrow-down text-3xl mb-2 animate-bounce"></i><p id="loading-text" class="text-xs">Sincronizando datos...</p></div>
                    </div>
                </div>
            </div>

            <!-- VISTA: Opciones (REORDENADA) -->
            <div id="view-opciones" class="hidden fade-in h-full">
                <div class="max-w-md mx-auto space-y-4">
                    
                    <!-- 1. REPORTES (AHORA ARRIBA) -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-black mb-4 flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-file-pdf text-red-600"></i> Reportes</h3>
                        <button onclick="askToPrint()" class="w-full py-4 bg-gray-900 text-white rounded-lg text-sm font-bold active:scale-[0.98] transition-transform flex items-center justify-center gap-2 shadow-md hover:bg-black border-b-4 border-gray-700">
                            <i class="fa-solid fa-print text-yellow-400"></i> Imprimir / Guardar PDF
                        </button>
                    </div>

                    <!-- 2. BASE DE DATOS (EN MEDIO) -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-black mb-4 flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-file-import text-green-600"></i> Base de Datos</h3>
                        <p class="text-xs text-gray-500 mb-4">Carga masiva de personal.</p>
                        <button onclick="openImportModal()" class="w-full py-4 bg-green-600 text-white rounded-lg text-sm font-bold active:scale-[0.98] transition-transform flex items-center justify-center gap-2 shadow-md hover:bg-green-700 border-b-4 border-green-800">
                            <i class="fa-solid fa-table"></i> Subir Lista (Excel/Sheets)
                        </button>
                    </div>

                    <!-- 3. CONFIGURACIÓN ROL (AHORA AL FINAL) -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-black mb-4 flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-calendar text-red-600"></i> Configuración Rol</h3>
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Inicio del Rol (Lunes)</label>
                            <div class="flex gap-2">
                                <input type="date" id="roleStartDate" onchange="saveStartDate(this.value)" disabled class="flex-1 px-3 py-3 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-black disabled:opacity-60">
                                <button onclick="openPasswordModal()" id="btnUnlockDate" class="w-12 flex items-center justify-center bg-gray-100 text-gray-500 rounded-lg active:bg-gray-200 border border-gray-200"><i class="fa-solid fa-lock"></i></button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- FONDO OSCURO PARA MODALES (Cierra al tocar) -->
    <div id="modalBackdrop" onclick="closeAllModals()" class="fixed inset-0 modal-backdrop hidden z-40 transition-opacity cursor-pointer"></div>

    <!-- --- ELEMENTO OCULTO PARA GENERAR PDF --- -->
    <div id="pdf-container" class="hidden">
        <div id="printable-content">
            <div class="pdf-header">
                <h1 style="font-size: 24px; font-weight: 900; margin: 0; color: #000; text-transform: uppercase;">Rol de Despachadores</h1>
                <h3 style="font-size: 14px; color: #dc2626; margin: 5px 0 0 0; text-transform: uppercase;">Forrajes El Barrio</h3>
                <p style="font-size: 12px; color: #666; margin-top: 5px;" id="pdf-date-range">Semana</p>
            </div>
            <table class="pdf-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Fecha</th>
                        <th style="width: 37.5%;">Turno 1</th>
                        <th style="width: 37.5%;">Turno 2</th>
                    </tr>
                </thead>
                <tbody id="pdf-table-body">
                    <!-- Contenido dinámico -->
                </tbody>
            </table>
            <div style="margin-top: 20px; font-size: 10px; color: #999; text-align: center; border-top: 1px solid #eee; padding-top: 10px;">
                Generado automáticamente por el Sistema de Gestión
            </div>
        </div>
    </div>

    <!-- MODALES (Estilo Barrio: Bordes redondeados, sombras fuertes, botones grandes) -->

    <!-- Modal Opciones de Rol (NUEVO: Centrado y grande) -->
    <div id="modalRoleOptions" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-xs p-6 pointer-events-auto transform scale-100 transition-all border-t-8 border-red-600">
            <h3 class="font-black text-xl text-center text-gray-800 mb-1" id="roleOptionsTitle">Opciones</h3>
            <p class="text-center text-xs text-gray-400 mb-6 uppercase tracking-wide" id="roleOptionsSubtitle">Acciones de casilla</p>
            
            <div class="flex flex-col gap-3">
                <button onclick="triggerRoleAction('replace')" class="py-4 bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 rounded-xl text-blue-700 font-bold flex items-center justify-center gap-3 active:scale-95 transition-transform">
                    <i class="fa-solid fa-rotate text-lg"></i> Reemplazar
                </button>
                
                <button onclick="triggerRoleAction('select')" class="py-4 bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 rounded-xl text-gray-700 font-bold flex items-center justify-center gap-3 active:scale-95 transition-transform">
                    <i class="fa-solid fa-check-square text-lg text-yellow-500"></i> Seleccionar (Grupo)
                </button>
                
                <button onclick="triggerRoleAction('delete')" class="py-4 bg-red-50 hover:bg-red-100 border-2 border-red-100 rounded-xl text-red-600 font-bold flex items-center justify-center gap-3 active:scale-95 transition-transform">
                    <i class="fa-solid fa-trash text-lg"></i> Borrar del Rol
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="closeM('modalRoleOptions')" class="text-xs text-gray-400 hover:text-gray-600 underline p-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Importación -->
    <div id="modalImport" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-lg p-6 pointer-events-auto flex flex-col h-[80vh] md:h-auto border-t-8 border-green-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-lg text-gray-800">IMPORTAR LISTA</h3>
                <button onclick="closeImportModal()" class="text-gray-300 hover:text-red-500 text-2xl"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="mb-4 bg-green-50 p-3 rounded-xl border border-green-100 text-xs text-green-800">
                <p class="font-bold mb-1"><i class="fa-solid fa-paste mr-1"></i> Instrucciones:</p>
                <p>Copia desde tu Excel/Google Sheets y pega aquí. <br>Formatos: <b>NOMBRE APELLIDO (ZONA)</b> ó 3 columnas.</p>
            </div>
            <textarea id="importText" class="flex-1 w-full p-3 border-2 border-gray-200 rounded-xl text-xs font-mono mb-4 focus:border-green-500 focus:ring-0 outline-none resize-none" placeholder="Ej: JUAN PEREZ (NORTE)..."></textarea>
            <div id="importStats" class="hidden mb-4 text-xs font-bold flex justify-between bg-gray-100 p-2 rounded-lg"><span>Total: <b id="statTotal">0</b></span><span class="text-green-600">Nuevos: <b id="statNew">0</b></span><span class="text-red-500">Duplicados: <b id="statDup">0</b></span></div>
            <div class="flex gap-2 shrink-0">
                <button onclick="previewImport()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl text-sm font-bold">Verificar</button>
                <button onclick="executeImport()" id="btnExecuteImport" class="flex-1 py-3 bg-green-600 text-white rounded-xl text-sm font-bold shadow-lg opacity-50" disabled>Subir</button>
            </div>
        </div>
    </div>

    <!-- Modal Selección con Buscador -->
    <div id="modalSelectDispatcher" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-md flex flex-col max-h-[85vh] pointer-events-auto border-t-8 border-blue-600">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white">
                <div><span class="text-[10px] font-bold text-gray-400 uppercase block">Asignar a</span><h3 class="font-bold text-gray-800 text-lg" id="selectTargetDate"></h3></div>
                <button onclick="closeSelectModal()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="px-4 py-2 bg-white border-b border-gray-100">
                <div class="relative"><i class="fa-solid fa-filter absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-300 text-xs"></i><input type="text" id="searchAssignment" oninput="renderAssignmentList()" class="w-full pl-8 pr-3 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl text-sm outline-none focus:border-blue-500 focus:bg-white transition-colors" placeholder="Filtrar despachador..."></div>
            </div>
            <div id="selectList" class="overflow-y-auto p-2 space-y-2 flex-1 bg-gray-50"></div>
            <div class="p-3 bg-white border-t border-gray-100 text-[10px] text-center text-gray-400 font-bold">SOLO PERSONAL QUE CUMPLE REGLAS</div>
        </div>
    </div>

    <!-- Modal Print -->
    <div id="modalPrintAsk" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-xl w-[85%] max-w-xs p-6 text-center pointer-events-auto border-b-8 border-red-600">
            <div class="w-14 h-14 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl border-4 border-white shadow-lg -mt-10"><i class="fa-solid fa-file-pdf"></i></div>
            <h3 class="font-black text-xl text-gray-900 mb-2 uppercase">Generar Reporte</h3>
            <p class="text-sm text-gray-500 mb-6">Elige el formato de salida.</p>
            <div class="space-y-3">
                <button onclick="generatePDF()" class="w-full py-3 bg-red-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><i class="fa-solid fa-download"></i> Guardar PDF</button>
                <button onclick="window.print()" class="w-full py-3 bg-gray-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-md active:scale-95 transition-transform"><i class="fa-solid fa-print text-yellow-400"></i> Imprimir</button>
                <button onclick="closePrintAskModal()" class="w-full py-2 text-gray-400 text-sm mt-2 underline">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modales Standard (Add, Edit, etc) - Estilizados -->
    <div id="modalPassword" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-xs p-6 text-center pointer-events-auto"><div class="mb-4 text-gray-800 font-bold text-lg">CONTRASEÑA MAESTRA</div><input type="number" id="inputPassword" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 text-center text-xl tracking-widest outline-none focus:border-red-500 bg-gray-50" placeholder="****"><div class="flex gap-2"><button onclick="closePasswordModal()" class="flex-1 py-3 bg-gray-100 rounded-xl text-gray-600 font-bold">Cancelar</button><button onclick="checkPassword()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold">Entrar</button></div></div></div>
    
    <div id="modalAdd" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm p-6 pointer-events-auto border-t-8 border-red-600"><h3 class="font-black text-lg text-gray-800 mb-4 uppercase">Nuevo Despachador</h3><div class="space-y-3"><input type="text" id="addNombre" placeholder="Nombre" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl outline-none focus:border-red-500 font-bold"><input type="text" id="addApellido" placeholder="Apellido" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl outline-none focus:border-red-500 font-bold"><input type="text" id="addArea" placeholder="Zona (Ej: Norte)" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl outline-none focus:border-red-500 font-bold"></div><div class="mt-6 flex gap-3"><button onclick="closeAddModal()" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="saveNewDispatcher()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg">Guardar</button></div></div></div>
    
    <div id="modalEdit" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm p-6 pointer-events-auto border-t-8 border-blue-600"><h3 class="font-black text-lg text-gray-800 mb-4 uppercase">Editar Datos</h3><div class="space-y-3"><div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Nombre</label><input type="text" id="editNombre" class="w-full px-3 py-2 bg-gray-50 border-2 border-gray-200 rounded-lg font-bold"></div><div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Apellido</label><input type="text" id="editApellido" class="w-full px-3 py-2 bg-gray-50 border-2 border-gray-200 rounded-lg font-bold"></div><div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Zona</label><input type="text" id="editArea" class="w-full px-3 py-2 bg-gray-50 border-2 border-gray-200 rounded-lg font-bold"></div><div id="editReasonContainer" class="hidden"><label class="block text-[10px] font-bold text-red-500 uppercase mb-1">Razón Inhabilitación</label><textarea id="editReason" rows="2" class="w-full px-3 py-2 bg-red-50 border-2 border-red-200 rounded-lg text-red-800 font-bold"></textarea></div></div><div class="mt-6 flex gap-3"><button onclick="closeEditModal()" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="saveEditDispatcher()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Guardar</button></div></div></div>
    
    <div id="modalDisable" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm overflow-hidden pointer-events-auto"><div class="bg-red-600 p-6 pb-4"><h3 class="font-black text-xl text-white uppercase"><i class="fa-solid fa-user-lock mr-2 text-yellow-400"></i>Inhabilitar</h3><p class="text-sm text-red-100 mt-1 font-bold"><span id="modalDisableName"></span></p></div><div class="p-6 pt-4"><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Hasta</label><input type="date" id="modalDisableDate" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 bg-white font-bold"><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Motivo</label><textarea id="modalDisableReason" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white font-bold" placeholder="Ej: Vacaciones..."></textarea><div class="flex gap-3 justify-end mt-6"><button onclick="closeDisableModal()" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="confirmDisable()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg">Confirmar</button></div></div></div></div>
    
    <div id="modalInfo" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm relative p-6 text-center pointer-events-auto"><button onclick="closeInfoModal()" class="absolute top-4 right-4 text-gray-300 p-2"><i class="fa-solid fa-times text-xl"></i></button><div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm"><i class="fa-solid fa-ban"></i></div><h2 class="text-lg font-black text-gray-800 uppercase" id="infoName"></h2><div class="mt-6 bg-red-50 p-4 rounded-xl border border-red-100 text-left"><p class="text-[10px] text-red-400 font-bold uppercase">Disponible en</p><p id="infoDays" class="text-base font-bold text-red-700 mb-2"></p><p class="text-[10px] text-red-400 font-bold uppercase border-t border-red-100 pt-2">Motivo</p><p id="infoReason" class="text-sm text-gray-700 italic font-medium"></p></div><button onclick="confirmReenable()" class="w-full mt-4 py-3 rounded-xl border-2 border-gray-200 text-gray-600 hover:bg-gray-50 font-bold">Re-habilitar ahora</button></div></div>
    
    <div id="modalAlert" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-xl w-[85%] max-w-xs p-6 text-center pointer-events-auto border-t-4 border-yellow-400"><div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i class="fa-solid fa-triangle-exclamation"></i></div><p id="alertMessage" class="text-gray-800 font-bold mb-5 text-sm"></p><button onclick="closeAlertModal()" class="w-full py-3 bg-gray-900 text-white rounded-xl text-sm font-bold">Entendido</button></div></div>
    
    <div id="modalConfirmAction" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-xl w-[85%] max-w-xs p-6 text-center pointer-events-auto"><div class="w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i class="fa-solid fa-question"></i></div><h3 id="confirmTitle" class="font-black text-lg text-gray-800 mb-2"></h3><p id="confirmMessage" class="text-sm text-gray-500 mb-6 font-medium"></p><div class="flex gap-2"><button onclick="closeConfirmModal()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl text-gray-500 font-bold">Cancelar</button><button id="btnConfirmAction" onclick="executeConfirm()" class="flex-1 py-3 bg-red-600 text-white rounded-xl text-sm font-bold shadow-lg">Confirmar</button></div></div></div>
    
    <div id="modalSwap" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 pointer-events-none"><div class="bg-white rounded-2xl shadow-xl w-[90%] max-w-xs p-6 text-center pointer-events-auto border-t-8 border-orange-500"><div class="mb-3 text-orange-500 text-3xl"><i class="fa-solid fa-right-left"></i></div><h3 class="font-black text-lg text-gray-800 uppercase">Lugar Ocupado</h3><p class="text-xs text-gray-500 mb-5 mt-1 font-bold">Ya hay alguien asignado aquí.</p><div class="flex flex-col gap-2"><button onclick="resolveSwap('swap')" id="btnSwap" class="py-3 bg-blue-600 text-white rounded-xl text-sm font-bold shadow-lg">Intercambiar Lugares</button><button onclick="resolveSwap('overwrite')" class="py-3 bg-white border-2 border-red-100 text-red-600 rounded-xl text-sm font-bold hover:bg-red-50">Sobrescribir (Borrar anterior)</button><button onclick="closeSwapModal()" class="py-3 text-gray-400 text-xs font-bold mt-1">Cancelar operación</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const manualConfig = {
          apiKey: "AIzaSyArRVSxwFF5-9D48VS-AZsb6_e2oIBUESk",
          authDomain: "rol-de-despachadores.firebaseapp.com",
          projectId: "rol-de-despachadores",
          storageBucket: "rol-de-despachadores.firebasestorage.app",
          messagingSenderId: "130708013498",
          appId: "1:130708013498:web:eb44b35cbbd59dc1d5dd83",
          measurementId: "G-77R1SFYX26"
        }; 

        let app, db, auth;
        let COLLECTION_PREFIX = '';
        let appId = 'default';

        if (typeof __firebase_config !== 'undefined') {
            app = initializeApp(JSON.parse(__firebase_config));
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            COLLECTION_PREFIX = `artifacts/${appId}/public/data/`;
        } else if (manualConfig) {
            app = initializeApp(manualConfig);
            COLLECTION_PREFIX = ''; 
        }

        const indicatorDot = document.getElementById('status-dot');

        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg);
            if(indicatorDot) indicatorDot.classList.replace('bg-orange-500', 'bg-red-500');
            return false;
        };

        if (app) {
            db = getFirestore(app);
            auth = getAuth(app);
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth Error:", error);
                    indicatorDot.classList.replace('bg-orange-500', 'bg-red-500');
                }
            };
            initAuth();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    indicatorDot.classList.replace('bg-orange-500', 'bg-green-500');
                    startListeners();
                }
            });
        } else {
            indicatorDot.classList.replace('bg-orange-500', 'bg-gray-400');
        }

        window.dispatchers = [];
        window.roles = {}; 
        window.currentRoleDates = [];
        window.roleStartDateString = '2026-01-05'; 
        let parsedImportData = []; 

        function startListeners() {
            onSnapshot(collection(db, COLLECTION_PREFIX + 'dispatchers'), (snapshot) => {
                window.dispatchers = [];
                snapshot.forEach(doc => window.dispatchers.push({ id: doc.id, ...doc.data() }));
                renderDispatchers();
                // Redibujar tabla para actualizar nombres o vacantes si se borró alguien
                if(!document.getElementById('view-roles').classList.contains('hidden')) renderRoleTable();
            });
            onSnapshot(collection(db, COLLECTION_PREFIX + 'roles'), (snapshot) => {
                window.roles = {};
                snapshot.forEach(doc => window.roles[doc.id] = doc.data());
                renderRoleTable();
            });
            const configRef = doc(db, COLLECTION_PREFIX + 'config', 'main');
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().startDate) {
                    window.roleStartDateString = docSnap.data().startDate;
                    document.getElementById('roleStartDate').value = window.roleStartDateString;
                    recalcDates();
                } else setDoc(configRef, { startDate: '2026-01-05' }).catch(e=>{});
            });
        }

        // --- MANEJO DE MODALES ---
        window.closeAllModals = () => {
            const modals = document.querySelectorAll('.fixed.z-50, .fixed.z-[60]');
            modals.forEach(m => {
                if(!m.classList.contains('hidden') && !m.classList.contains('pointer-events-none')) {
                    // Cerrar solo si está visible y activo
                    // Verificar IDs para llamar funciones de cierre especificas si es necesario
                    if(m.id === 'modalRoleOptions') closeM('modalRoleOptions');
                    else if(m.id === 'modalSelectDispatcher') closeSelectModal();
                    else if(m.id === 'modalImport') closeImportModal();
                    else if(m.id === 'modalAdd') closeAddModal();
                    else if(m.id === 'modalEdit') closeEditModal();
                    else if(m.id === 'modalDisable') closeDisableModal();
                    else if(m.id === 'modalInfo') closeInfoModal();
                    else if(m.id === 'modalPrintAsk') closePrintAskModal();
                    else if(m.id === 'modalPassword') closePasswordModal();
                    // Alert y Confirm se quedan abiertos para forzar acción, o se cierran tambien? Mejor cerrar.
                    else if(m.id === 'modalAlert') closeAlertModal();
                    // Swap y ConfirmAction requieren respuesta explicita, no cerrar con click afuera por seguridad
                }
            });
        }

        // --- GENERAR PDF CON HTML2PDF ---
        window.generatePDF = () => {
            closePrintAskModal();
            // Llenar datos de la tabla oculta
            const tbody = document.getElementById('pdf-table-body');
            tbody.innerHTML = '';
            
            // Set date range
            const start = new Date(window.currentRoleDates[0]);
            const end = new Date(window.currentRoleDates[window.currentRoleDates.length-1]);
            document.getElementById('pdf-date-range').innerText = `Del ${start.toLocaleDateString()} al ${end.toLocaleDateString()}`;

            window.currentRoleDates.forEach(dateStr => {
                const dateObj = new Date(dateStr + 'T12:00:00');
                const dateFmt = new Intl.DateTimeFormat('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }).format(dateObj).toUpperCase();
                
                const roleData = window.roles[dateStr] || {};
                const d1Id = roleData[0];
                const d2Id = roleData[1];
                
                // Buscar despachador, si no existe (borrado), es null
                const d1 = d1Id ? window.dispatchers.find(d => d.id === d1Id) : null;
                const d2 = d2Id ? window.dispatchers.find(d => d.id === d2Id) : null;

                const t1 = d1 ? `<b>${d1.name} ${d1.lastname}</b> <br><small style="color:#666">(${d1.area})</small>` : '<span class="pdf-vacante">Vacante</span>';
                const t2 = d2 ? `<b>${d2.name} ${d2.lastname}</b> <br><small style="color:#666">(${d2.area})</small>` : '<span class="pdf-vacante">Vacante</span>';

                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight: bold; background-color: #f9f9f9;">${dateFmt}</td>
                        <td>${t1}</td>
                        <td>${t2}</td>
                    </tr>
                `;
            });

            const element = document.getElementById('printable-content');
            const opt = {
                margin:       0.5,
                filename:     `rol_despachadores_${window.currentRoleDates[0]}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Usar html2pdf
            html2pdf().set(opt).from(element).save();
        };

        // --- IMPORTACIÓN HÍBRIDA ---
        window.openImportModal = () => {
            document.getElementById('importText').value = '';
            document.getElementById('importStats').classList.add('hidden');
            document.getElementById('btnExecuteImport').disabled = true;
            document.getElementById('btnExecuteImport').classList.add('opacity-50', 'cursor-not-allowed');
            parsedImportData = [];
            openM('modalImport');
        }
        window.closeImportModal = () => closeM('modalImport');

        window.previewImport = () => {
            const text = document.getElementById('importText').value;
            if(!text.trim()) return showAlert("Pega los datos primero.");

            parsedImportData = [];
            let duplicates = 0;

            const regexOneLine = /([^\(]+?)\s*\(([^)]+)\)/g;
            let match;
            let foundRegex = false;
            
            while ((match = regexOneLine.exec(text)) !== null) {
                foundRegex = true;
                const rawName = match[1].trim(); 
                const area = match[2].trim();
                const nameParts = rawName.split(/\s+/);
                let name = "", lastname = "";

                if (nameParts.length > 1) { lastname = nameParts.pop(); name = nameParts.join(" "); } 
                else { name = rawName; lastname = "."; }

                if(name && area) {
                    const exists = window.dispatchers.some(d => d.name.toLowerCase() === name.toLowerCase() && d.lastname.toLowerCase() === lastname.toLowerCase());
                    if(exists) duplicates++;
                    else parsedImportData.push({ name, lastname, area, active: true, disabledUntil: null, reason: '' });
                }
            }

            if (!foundRegex || parsedImportData.length === 0) {
                 const rows = text.split(/\r?\n/);
                 rows.forEach(row => {
                    if(!row.trim()) return;
                    let cols = row.split('\t');
                    if(cols.length < 3) cols = row.split(','); 
                    if(cols.length >= 3) {
                        const n = cols[0].trim(); const l = cols[1].trim(); const a = cols[2].trim();
                        if(n && l) {
                             const exists = window.dispatchers.some(d => d.name.toLowerCase() === n.toLowerCase() && d.lastname.toLowerCase() === l.toLowerCase());
                             if(exists) duplicates++;
                             else parsedImportData.push({ name: n, lastname: l, area: a, active: true, disabledUntil: null, reason: '' });
                        }
                    }
                 });
            }

            document.getElementById('statTotal').innerText = parsedImportData.length + duplicates;
            document.getElementById('statNew').innerText = parsedImportData.length;
            document.getElementById('statDup').innerText = duplicates;
            document.getElementById('importStats').classList.remove('hidden');

            const btn = document.getElementById('btnExecuteImport');
            if(parsedImportData.length > 0) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                if(duplicates > 0 && parsedImportData.length === 0) showAlert("Todos los registros ya existen.");
                else if (parsedImportData.length === 0) showAlert("No se detectó formato válido.");
            }
        }

        window.executeImport = async () => {
            if(parsedImportData.length === 0) return;
            const btn = document.getElementById('btnExecuteImport');
            btn.innerText = "Subiendo...";
            btn.disabled = true;
            const batch = writeBatch(db);
            const colRef = collection(db, COLLECTION_PREFIX + 'dispatchers');
            parsedImportData.forEach(item => { const newDoc = doc(colRef); batch.set(newDoc, item); });
            try { await batch.commit(); closeImportModal(); showAlert(`¡Éxito! Importados: ${parsedImportData.length}`); } 
            catch(e) { console.error(e); showAlert("Error al subir."); } 
            finally { btn.innerText = "Subir a Base de Datos"; }
        }

        window.saveNewDispatcher = async function() {
            const n = document.getElementById('addNombre').value.trim();
            const l = document.getElementById('addApellido').value.trim();
            const a = document.getElementById('addArea').value.trim();
            if(!n || !l || !a) { showAlert("Completa todos los campos"); return; }
            const newDocRef = doc(collection(db, COLLECTION_PREFIX + 'dispatchers'));
            await setDoc(newDocRef, { name: n, lastname: l, area: a, active: true, disabledUntil: null, reason: '' });
            closeAddModal();
        }
        window.deleteDispatcher = function(id) { showConfirm("¿Eliminar?", "Esta acción es irreversible.", async () => { await deleteDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', id)); }); }
        window.saveEditDispatcher = async function() {
            if (!editingId) return;
            const n = document.getElementById('editNombre').value.trim();
            const l = document.getElementById('editApellido').value.trim();
            const a = document.getElementById('editArea').value.trim();
            const updateData = { name: n, lastname: l, area: a };
            const d = window.dispatchers.find(x => x.id === editingId);
            if (!d.active) updateData.reason = document.getElementById('editReason').value;
            await updateDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', editingId), updateData);
            closeEditModal();
        }
        window.confirmDisable = async function() {
            const date = document.getElementById('modalDisableDate').value;
            const r = document.getElementById('modalDisableReason').value;
            if(!date || !r) return showAlert("Faltan datos");
            await updateDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', editingId), { active: false, disabledUntil: date, reason: r });
            closeDisableModal();
        }
        window.confirmReenable = async function() { await updateDoc(doc(db, COLLECTION_PREFIX + 'dispatchers', viewingId), { active: true, disabledUntil: null, reason: '' }); closeInfoModal(); }
        window.assignDispatcher = async function(id) {
            const roleRef = doc(db, COLLECTION_PREFIX + 'roles', selectedDate);
            const updateData = {}; updateData[selectedSlot] = id;
            await setDoc(roleRef, updateData, { merge: true });
            closeSelectModal();
        }
        window.clearRoleSlot = async function(d, s) {
            const roleRef = doc(db, COLLECTION_PREFIX + 'roles', d);
            await updateDoc(roleRef, { [s]: null }).catch(async (e) => {});
            window.selectedSlots = window.selectedSlots.filter(sl => !(sl.date === d && sl.slot === s));
            renderRoleTable();
        }
        window.performMove = async function(fd, fs, td, ts) {
            await updateDoc(doc(db, COLLECTION_PREFIX + 'roles', fd), { [fs]: null });
            await setDoc(doc(db, COLLECTION_PREFIX + 'roles', td), { [ts]: draggedData.id }, { merge: true });
            draggedData = null;
        }
        window.executeGroupMove = async function(moves) {
            const promises = [];
            for (const m of moves) { const ref = doc(db, COLLECTION_PREFIX + 'roles', m.oldDate); promises.push(updateDoc(ref, { [m.oldSlot]: null })); }
            await Promise.all(promises);
            const writePromises = [];
            for (const m of moves) { const ref = doc(db, COLLECTION_PREFIX + 'roles', m.newDate); writePromises.push(setDoc(ref, { [m.newSlot]: m.id }, { merge: true })); }
            await Promise.all(writePromises);
            window.selectedSlots = [];
            renderRoleTable();
        }
        window.saveStartDate = async function(val) { await setDoc(doc(db, COLLECTION_PREFIX + 'config', 'main'), { startDate: val }); }

        let editingId = null; let viewingId = null; let selectedDate = null; let selectedSlot = null; window.selectedSlots = []; let draggedData = null; let swapTargetData = null; let confirmCallback = null; 
        
        // MODALES CORE
        const toggleBackdrop = (show) => document.getElementById('modalBackdrop').classList.toggle('hidden', !show);
        const openM = (id) => { toggleBackdrop(true); document.getElementById(id).classList.remove('hidden'); }
        const closeM = (id) => { toggleBackdrop(false); document.getElementById(id).classList.add('hidden'); }
        
        // --- MANEJO DE OPCIONES DE ROL (NUEVO MODAL) ---
        let currentRoleOptions = null;
        window.openRoleOptions = (date, slot) => {
            currentRoleOptions = { date, slot };
            const dispId = window.roles[date][slot];
            const disp = window.dispatchers.find(d => d.id === dispId);
            
            document.getElementById('roleOptionsTitle').innerText = disp ? `${disp.name} ${disp.lastname}` : 'Opciones';
            document.getElementById('roleOptionsSubtitle').innerText = new Date(date+'T12:00:00').toLocaleDateString();
            
            openM('modalRoleOptions');
        }
        
        window.triggerRoleAction = (action) => {
            closeM('modalRoleOptions');
            if(!currentRoleOptions) return;
            const { date, slot } = currentRoleOptions;
            
            if(action === 'replace') openSelectModal(date, slot);
            else if(action === 'select') toggleSelection(date, slot);
            else if(action === 'delete') clearRoleSlot(date, slot);
        }

        window.showAlert = (msg) => { document.getElementById('alertMessage').innerText = msg; openM('modalAlert'); }
        window.closeAlertModal = () => closeM('modalAlert');
        window.showConfirm = (title, msg, callback) => { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMessage').innerText = msg; confirmCallback = callback; openM('modalConfirmAction'); }
        window.executeConfirm = () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); }
        window.closeConfirmModal = () => { closeM('modalConfirmAction'); confirmCallback = null; }
        window.openPasswordModal = () => { if(!document.getElementById('roleStartDate').disabled) return; document.getElementById('inputPassword').value=''; openM('modalPassword'); setTimeout(()=>document.getElementById('inputPassword').focus(),100); }
        window.closePasswordModal = () => closeM('modalPassword');
        window.checkPassword = () => { if(document.getElementById('inputPassword').value==="1235"){ document.getElementById('roleStartDate').disabled=false; document.getElementById('btnUnlockDate').innerHTML='<i class="fa-solid fa-lock-open text-green-500"></i>'; closePasswordModal(); showAlert("Fecha desbloqueada."); } else { showAlert("Contraseña incorrecta."); } }
        window.switchTab = (tab) => {
            ['despachadores', 'roles', 'opciones'].forEach(v => {
                document.getElementById('view-'+v).classList.add('hidden');
                const b = document.getElementById('tab-'+v);
                b.classList.replace('border-red-600','border-transparent');
                b.classList.replace('text-red-700','text-gray-400');
                b.classList.remove('bg-gray-50');
            });
            document.getElementById('view-'+tab).classList.remove('hidden');
            const b = document.getElementById('tab-'+tab);
            b.classList.replace('border-transparent','border-red-600');
            b.classList.replace('text-gray-400','text-red-700');
            b.classList.add('bg-gray-50');
            const btn = document.getElementById('btnNewDispatcher');
            if(tab === 'despachadores') btn.classList.remove('invisible'); else btn.classList.add('invisible');
            if(tab === 'roles') { recalcDates(); renderRoleTable(); }
        }
        window.askToPrint = () => openM('modalPrintAsk');
        window.closePrintAskModal = () => closeM('modalPrintAsk');
        
        window.openEditModal = (id) => {
            editingId = id;
            const d = window.dispatchers.find(x => x.id === id);
            document.getElementById('editNombre').value = d.name;
            document.getElementById('editApellido').value = d.lastname;
            document.getElementById('editArea').value = d.area;
            const rc = document.getElementById('editReasonContainer');
            if(!d.active){ rc.classList.remove('hidden'); document.getElementById('editReason').value = d.reason; } else { rc.classList.add('hidden'); }
            closeAllMenus();
            openM('modalEdit');
        }
        window.closeEditModal = () => { closeM('modalEdit'); editingId = null; }
        window.openAddModal = () => { document.getElementById('addNombre').value=''; document.getElementById('addApellido').value=''; document.getElementById('addArea').value=''; openM('modalAdd'); }
        window.closeAddModal = () => closeM('modalAdd');

        // --- RENDER (MODIFICADO CON BÚSQUEDA) ---
        window.renderDispatchers = () => {
            const query = document.getElementById('searchDispatcher')?.value.toLowerCase() || '';
            const c = document.getElementById('listaDespachadores');
            c.innerHTML = '';
            
            const filtered = window.dispatchers.filter(d => 
                (d.name + ' ' + d.lastname + ' ' + d.area).toLowerCase().includes(query)
            );
            
            document.getElementById('counter').innerText = filtered.length;

            if(filtered.length===0) { c.innerHTML='<div class="text-center py-10 opacity-50 text-xs text-gray-400 font-bold uppercase">Sin resultados</div>'; return; }
            
            filtered.forEach(d => {
                const el = document.createElement('div');
                const base = "relative bg-white p-3 rounded-xl border-b-2 border-gray-100 shadow-sm transition-all flex items-center justify-between";
                const st = d.active ? "border-gray-100" : "border-red-100 bg-red-50";
                const btnColor = d.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const btnText = d.active ? 'ACTIVO' : 'BAJA';
                const statusBtn = `<button onclick="handleStatus(event, '${d.id}')" class="px-3 py-1.5 ${btnColor} text-[10px] font-black rounded-lg tracking-wider border-b-2 border-green-200">${btnText}</button>`;
                const iconBg = d.active ? 'bg-gray-100 text-gray-500' : 'bg-red-200 text-red-600';
                if(!d.active) { el.onclick = (e) => { if(!e.target.closest('button')) showInfoModal(d.id); }; }
                el.className = `${base} ${st}`;
                el.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-10 h-10 ${iconBg} rounded-full flex-shrink-0 flex items-center justify-center text-sm font-bold border border-gray-100"><i class="fa-solid fa-user"></i></div>
                        <div class="min-w-0">
                            <h4 class="${d.active?'text-gray-800':'text-red-800'} font-black text-sm truncate leading-tight">${d.name} ${d.lastname}</h4>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wide truncate">${d.area}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">${statusBtn}<div class="relative"><button onclick="toggleMenu(event, 'menu-${d.id}')" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 active:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-ellipsis-vertical"></i></button><div id="menu-${d.id}" class="dropdown-menu hidden absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-2xl border border-gray-100 z-10 overflow-hidden"><button onclick="openEditModal('${d.id}')" class="w-full text-left px-4 py-3 text-sm text-gray-700 active:bg-gray-50 flex items-center gap-3 border-b border-gray-50 font-bold"><i class="fa-solid fa-pen text-blue-600"></i> Editar</button><button onclick="deleteDispatcher('${d.id}')" class="w-full text-left px-4 py-3 text-sm text-red-600 active:bg-red-50 flex items-center gap-3 font-bold"><i class="fa-solid fa-trash"></i> Eliminar</button></div></div></div>`;
                c.appendChild(el);
            });
        }

        window.recalcDates = () => {
            const startDate = new Date(window.roleStartDateString + 'T12:00:00');
            window.currentRoleDates = [];
            let processDate = new Date(startDate);
            let daysAdded = 0;
            while(daysAdded < 12) {
                if(processDate.getDay() !== 0) { window.currentRoleDates.push(processDate.toISOString().split('T')[0]); daysAdded++; }
                processDate.setDate(processDate.getDate() + 1);
            }
        }
        window.renderRoleTable = () => {
            if(window.currentRoleDates.length === 0) recalcDates();
            const c = document.getElementById('roleTableBody');
            const pc = document.getElementById('printable-area');
            c.innerHTML = '';
            
            const selBar = document.getElementById('selection-bar');
            if(window.selectedSlots.length > 0) { selBar.classList.remove('hidden'); selBar.classList.add('flex'); } else { selBar.classList.add('hidden'); selBar.classList.remove('flex'); }
            window.currentRoleDates.forEach(dateStr => {
                const dateObj = new Date(dateStr + 'T12:00:00');
                const dateFmt = new Intl.DateTimeFormat('es-ES', { weekday: 'long', day: 'numeric', month: 'short' }).format(dateObj).toUpperCase().replace('.', '');
                const roleData = window.roles[dateStr] || {};
                const d1Id = roleData[0]; const d2Id = roleData[1];
                const row = document.createElement('div');
                row.className = "flex flex-col md:grid md:grid-cols-12 md:items-stretch mb-4 md:mb-0 bg-white md:bg-transparent shadow-sm md:shadow-none rounded-xl md:rounded-none overflow-hidden border border-gray-200 md:border-0 md:border-b md:border-gray-200";
                row.innerHTML = `<div class="p-2 md:p-3 bg-gray-100 md:bg-white md:col-span-3 flex items-center justify-between md:justify-start border-b md:border-b-0 border-gray-200"><span class="text-xs font-black text-gray-500">${dateFmt}</span></div><div class="grid grid-cols-2 md:contents"><div class="p-2 border-r border-gray-100 md:border-gray-200 relative group md:col-span-4" ondragover="allowDrop(event)" ondrop="drop(event, '${dateStr}', 0)">${renderSlotContent(dateStr, 0, d1Id)}</div><div class="p-2 relative group md:col-span-4" ondragover="allowDrop(event)" ondrop="drop(event, '${dateStr}', 1)">${renderSlotContent(dateStr, 1, d2Id)}</div></div><div class="hidden md:block md:col-span-1"></div>`;
                c.appendChild(row);
            });
        }
        window.renderSlotContent = (date, slot, dispatcherId) => {
            if (!dispatcherId) return `<button onclick="openSelectModal('${date}', ${slot})" class="w-full h-12 md:h-full border-2 border-dashed border-gray-300 rounded-lg text-gray-300 active:bg-gray-50 active:border-gray-400 transition-all flex items-center justify-center bg-gray-50/50"><i class="fa-solid fa-plus text-lg font-bold"></i></button>`;
            
            // Check dispatcher existence gracefully
            const disp = window.dispatchers.find(d => d.id === dispatcherId);
            
            // SI SE BORRÓ EL DESPACHADOR PERO SIGUE EN ROL, MOSTRAR VACANTE EN VEZ DE ERROR
            if (!disp) return `<button onclick="openSelectModal('${date}', ${slot})" class="w-full h-12 md:h-full border-2 border-dashed border-gray-300 rounded-lg text-gray-300 active:bg-gray-50 active:border-gray-400 transition-all flex items-center justify-center bg-gray-50/50"><i class="fa-solid fa-plus text-lg font-bold"></i></button>`; 
            
            const isSel = window.selectedSlots.some(s => s.date === date && s.slot === slot);
            const cl = isSel ? 'card-selected' : 'border-gray-200 bg-white';
            return `<div class="w-full h-full p-2 rounded-lg border ${cl} flex flex-col justify-center relative cursor-grab active:cursor-grabbing shadow-sm" draggable="true" ondragstart="drag(event, '${date}', ${slot}, '${dispatcherId}')"><p class="text-xs font-black text-gray-800 truncate leading-tight">${disp.name}</p><p class="text-xs text-gray-500 truncate leading-tight mb-1 font-medium">${disp.lastname}</p><p class="text-[9px] font-black text-gray-300 uppercase tracking-wide">(${disp.area})</p><button onclick="openRoleOptions('${date}', ${slot})" class="absolute top-1 right-1 w-8 h-8 flex items-center justify-center text-gray-300 active:text-gray-600 rounded-full active:bg-gray-100"><i class="fa-solid fa-ellipsis-vertical text-sm"></i></button></div>`;
        }
        function getWeekIndex(dateStr) { const idx = window.currentRoleDates.indexOf(dateStr); return idx === -1 ? -1 : (idx < 6 ? 0 : 1); }
        function checkRules(tDate, tSlot, dId, xDate=null, xSlot=null) {
            const partnerSlot = tSlot === 0 ? 1 : 0;
            const roleData = window.roles[tDate] || {};
            const pId = roleData[partnerSlot];
            if (pId && pId !== dId) {
                const partner = window.dispatchers.find(d => d.id === pId);
                const mover = window.dispatchers.find(d => d.id === dId);
                // Graceful check if partner was deleted
                if (partner && mover && partner.area === mover.area) return { valid: false, msg: `Misma Zona (${mover.area})` };
            }
            const tWeek = getWeekIndex(tDate);
            let cW = 0; let cT = 0;
            for (const d of window.currentRoleDates) {
                const r = window.roles[d]; if (!r) continue;
                for (let s = 0; s <= 1; s++) {
                    const id = r[s];
                    if (id === dId) { if (d === xDate && s === xSlot) continue; cT++; if (getWeekIndex(d) === tWeek) cW++; }
                }
            }
            if (cW >= 1) return { valid: false, msg: `Ya tiene turno en semana` };
            if (cT >= 2) return { valid: false, msg: `Máximo 2 turnos quincena` };
            return { valid: true };
        }

        // --- FUNCIONES MODIFICADAS PARA BUSCADOR EN MODAL ---
        window.openSelectModal = (d, s) => {
            selectedDate=d; selectedSlot=s;
            document.getElementById('selectTargetDate').innerText = new Date(d+'T12:00:00').toLocaleDateString();
            document.getElementById('searchAssignment').value = ''; // Resetear busqueda
            renderAssignmentList();
            openM('modalSelectDispatcher');
        }

        window.renderAssignmentList = () => {
            const query = document.getElementById('searchAssignment')?.value.toLowerCase() || '';
            const c = document.getElementById('selectList');
            c.innerHTML = '';
            
            const cands = window.dispatchers.filter(dp => {
                if(!dp.active) return false;
                // Filtro Texto
                const textMatch = (dp.name + ' ' + dp.lastname + ' ' + dp.area).toLowerCase().includes(query);
                if (!textMatch) return false;
                // Filtro Reglas
                const check = checkRules(selectedDate, selectedSlot, dp.id);
                return check.valid;
            });

            if(cands.length === 0) c.innerHTML = '<div class="text-center p-4 text-gray-400 text-xs font-bold">No disponible por reglas.</div>';
            else cands.forEach(dp => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-4 bg-white border border-gray-100 shadow-sm rounded-xl flex justify-between items-center active:bg-blue-50 active:border-blue-200 mb-2";
                b.onclick = () => assignDispatcher(dp.id);
                b.innerHTML = `<div><span class="font-black text-sm text-gray-800">${dp.name} ${dp.lastname}</span><span class="text-[10px] font-bold text-gray-400 uppercase ml-2 bg-gray-100 px-2 py-0.5 rounded-full">${dp.area}</span></div>`;
                c.appendChild(b);
            });
        }

        window.toggleSelection = (d, s) => { closeM('modalRoleOptions'); const idx = window.selectedSlots.findIndex(i => i.date === d && i.slot === s); if(idx === -1) window.selectedSlots.push({date:d, slot:s}); else window.selectedSlots.splice(idx, 1); renderRoleTable(); }
        window.clearSelection = () => { window.selectedSlots = []; renderRoleTable(); }
        window.closeSelectModal = () => closeM('modalSelectDispatcher');
        window.drag = (e,d,s,id) => { 
            const isGroup = window.selectedSlots.some(sl => sl.date === d && sl.slot === s);
            draggedData = { originDate: d, originSlot: s, id: id, isGroup: isGroup, group: isGroup ? [...window.selectedSlots] : [] };
            e.dataTransfer.setData("text", JSON.stringify(draggedData));
        }
        window.allowDrop = (e) => e.preventDefault();
        window.dragEnter = (e) => { e.preventDefault(); e.currentTarget.classList.add('droppable-hover'); }
        window.dragLeave = (e) => e.currentTarget.classList.remove('droppable-hover');
        window.drop = (e, td, ts) => {
            e.preventDefault(); e.currentTarget.classList.remove('droppable-hover');
            if(!draggedData) return;
            if(draggedData.isGroup && draggedData.group.length > 0) handleGroupDrop(td, ts);
            else { if(draggedData.originDate===td && draggedData.originSlot===ts) return; handleSingleDrop(td, ts); }
        }
        function handleSingleDrop(td, ts) {
            const check = checkRules(td, ts, draggedData.id, draggedData.originDate, draggedData.originSlot);
            if(!check.valid) return showAlert(check.msg);
            if(window.roles[td] && window.roles[td][ts]) { swapTargetData = { date: td, slot: ts, isGroup: false }; openM('modalSwap'); }
            else performMove(draggedData.originDate, draggedData.originSlot, td, ts);
        }
        function handleGroupDrop(td, ts) {
            const originIndex = window.currentRoleDates.indexOf(draggedData.originDate);
            const targetIndex = window.currentRoleDates.indexOf(td);
            const dayDiff = targetIndex - originIndex;
            let proposedMoves = [];
            for (let item of draggedData.group) {
                const itemOriginIdx = window.currentRoleDates.indexOf(item.date);
                const newIdx = itemOriginIdx + dayDiff;
                if(newIdx < 0 || newIdx >= window.currentRoleDates.length) return showAlert("Fuera de rango");
                const newDate = window.currentRoleDates[newIdx];
                let newSlot = item.slot; 
                if(item.slot === draggedData.originSlot) newSlot = ts; 
                const dispatcherId = window.roles[item.date] ? window.roles[item.date][item.slot] : null;
                if(!dispatcherId) continue; 
                proposedMoves.push({ id: dispatcherId, oldDate: item.date, oldSlot: item.slot, newDate, newSlot });
            }
            let overwriteNeeded = false;
            for(let move of proposedMoves) {
                const check = checkRules(move.newDate, move.newSlot, move.id, move.oldDate, move.oldSlot);
                if(!check.valid) return showAlert(check.msg);
                const occupantId = window.roles[move.newDate] ? window.roles[move.newDate][move.newSlot] : null;
                const occupantIsLeaving = proposedMoves.some(m => m.oldDate === move.newDate && m.oldSlot === move.newSlot);
                if(occupantId && !occupantIsLeaving) overwriteNeeded = true;
            }
            if(overwriteNeeded) { swapTargetData = { isGroup: true, moves: proposedMoves }; document.getElementById('btnSwap').classList.add('hidden'); openM('modalSwap'); }
            else executeGroupMove(proposedMoves);
        }
        window.resolveSwap = async function(action) {
            const isGroup = swapTargetData.isGroup;
            if(isGroup) {
                if(action === 'overwrite') await executeGroupMove(swapTargetData.moves);
                document.getElementById('btnSwap').classList.remove('hidden');
            } else {
                const o = draggedData; const t = swapTargetData;
                if(action === 'overwrite') {
                    await updateDoc(doc(db, COLLECTION_PREFIX + 'roles', t.date), { [t.slot]: null }); 
                    await updateDoc(doc(db, COLLECTION_PREFIX + 'roles', o.originDate), { [o.originSlot]: null });
                    await setDoc(doc(db, COLLECTION_PREFIX + 'roles', t.date), { [t.slot]: o.id }, { merge: true });
                } else if(action === 'swap') {
                    const tId = window.roles[t.date][t.slot];
                    const checkX = checkRules(t.date, t.slot, o.id, o.originDate, o.originSlot);
                    const checkZ = checkRules(o.originDate, o.originSlot, tId, t.date, t.slot);
                    if(!checkX.valid || !checkZ.valid) { closeSwapModal(); return showAlert("Reglas impiden intercambio"); }
                    const p1 = setDoc(doc(db, COLLECTION_PREFIX + 'roles', o.originDate), { [o.originSlot]: tId }, { merge: true });
                    const p2 = setDoc(doc(db, COLLECTION_PREFIX + 'roles', t.date), { [t.slot]: o.id }, { merge: true });
                    await Promise.all([p1, p2]);
                }
            }
            closeSwapModal();
        }
        window.closeSwapModal = () => closeM('modalSwap');
        window.toggleMenu = (e,id) => { e.stopPropagation(); closeAllMenus(); document.getElementById(id).classList.remove('hidden'); }
        window.closeAllMenus = () => document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.add('hidden'));
        window.handleStatus = (e,id) => { e.stopPropagation(); closeAllMenus(); const d=window.dispatchers.find(x=>x.id===id); if(d.active) { document.getElementById('modalDisableName').innerText=`${d.name} ${d.lastname}`; document.getElementById('modalDisableDate').value=''; document.getElementById('modalDisableReason').value=''; editingId=id; openM('modalDisable'); } else showInfoModal(id); }
        window.closeDisableModal = () => closeM('modalDisable');
        window.showInfoModal = (id) => { viewingId=id; const d=window.dispatchers.find(x=>x.id===id); document.getElementById('infoName').innerText=`${d.name} ${d.lastname}`; document.getElementById('infoReason').innerText=d.reason; document.getElementById('infoDays').innerText=new Date(d.disabledUntil+'T12:00:00').toLocaleDateString(); openM('modalInfo'); }
        window.closeInfoModal = () => closeM('modalInfo');
        if(!app) { renderDispatchers(); renderRoleTable(); }
    </script>
</body>
</html>
